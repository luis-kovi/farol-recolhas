/**
 * @OnlyCurrentDoc
 */

/**
 * Lida com as requisi√ß√µes GET da sua aplica√ß√£o.
 * AGORA INCLUI VALIDA√á√ÉO DE USU√ÅRIO E FILTROS POR PERMISS√ÉO.
 * @param {Object} e O objeto de evento da requisi√ß√£o.
 * @returns {ContentService.TextOutput} Os dados dos cards ou um erro de autoriza√ß√£o.
 */
function doGet(e) {
  e = e || { parameter: {} };
  e.parameter = e.parameter || {};

  if (e.parameter.action === 'calcular') {
    return handleCalculatorRequest(e);
  }

  const userEmail = e.parameter.email;
  const userPermission = checkUserPermission(userEmail);

  if (!userPermission.authorized) {
    const errorData = {
      error: "Acesso n√£o autorizado. Verifique se o seu e-mail est√° na lista de permiss√µes da planilha.",
      cards: []
    };
    return ContentService.createTextOutput(JSON.stringify(errorData))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const data = getGoogleSheetData(userPermission.permissionType);
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Lida com as requisi√ß√µes da calculadora
 */
function handleCalculatorRequest(e) {
  const origem = e.parameter.origem;
  const destino = e.parameter.destino;
  const resultado = calcularDistanciaEEndereco(origem, destino);
  return ContentService.createTextOutput(resultado)
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Busca e processa os dados da planilha "Cards" com filtro por permiss√£o.
 */
function getGoogleSheetData(permissionType) {
  const spreadsheetId = '1MO_MqQgyoxpaqgwmLjXttxAa3_YckweKTj1CGlBouA8';
  const sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName('Cards');
  if (!sheet) throw new Error('Aba "Cards" n√£o encontrada');

  const values = sheet.getDataRange().getValues();
  const headers = values.shift();
  const mapIdx = headers.reduce((m,h,i)=>{m[h.trim()]=i;return m;},{ });
  const hoje = new Date();

  const cards = values.map(row=>{
    const dataCri = row[mapIdx['Data Cria√ß√£o']];
    const sla = dataCri instanceof Date ? Math.floor((hoje - dataCri)/(1000*60*60*24)) : 0;
    return { sla, empresaResponsavel: (row[mapIdx['Empresa Respons√°vel']]||'').toString().toLowerCase().trim() };
  }).filter(c=> permissionType.toLowerCase()==='kovi' || c.empresaResponsavel===permissionType.toLowerCase());

  return { cards, lastUpdate: Utilities.formatDate(hoje,'America/Sao_Paulo','dd/MM/yyyy HH:mm:ss') };
}

/**
 * Verifica permiss√£o de usu√°rio
 */
function checkUserPermission(email) {
  if (!email) return { authorized:false, permissionType:null };
  try {
    const ss = SpreadsheetApp.openById('1MO_MqQgyoxpaqgwmLjXttxAa3_YckweKTj1CGlBouA8');
    const sheet = ss.getSheetByName('Usuarios');
    if (!sheet) throw new Error('Aba "Usuarios" n√£o encontrada');
    const rows = sheet.getRange(2,1,sheet.getLastRow()-1,2).getValues();
    for (const [e,perm] of rows) {
      if (e && e.toString().toLowerCase().trim()===email.toLowerCase()) {
        return { authorized:true, permissionType: perm ? perm.toString().trim() : 'ativa' };
      }
    }
  } catch (err) {
    Logger.log('Erro ao verificar permiss√£o: ' + err.toString());
  }
  return { authorized:false, permissionType:null };
}

/**
 * Calcula dist√¢ncia e busca endere√ßo
 */
function calcularDistanciaEEndereco(orig, dest) {
  const [latO,lonO] = orig.split(',').map(Number);
  const [latD,lonD] = dest.split(',').map(Number);
  const routeToken = PropertiesService.getScriptProperties().getProperty('OPEN_ROUTE_TOKEN');
  const cageToken = PropertiesService.getScriptProperties().getProperty('OPEN_CAGE_TOKEN');
  if (!routeToken || !cageToken) return JSON.stringify({ error:'Tokens n√£o configurados.' });

  let res = { endereco:'', distanciaHtml:'', error:'' };
  try {
    const geoRes = UrlFetchApp.fetch(
      `https://api.opencagedata.com/geocode/v1/json?q=${latO}+${lonO}&key=${cageToken}&language=pt-br`
    );
    const geo = JSON.parse(geoRes.getContentText());
    res.endereco = geo.results[0]?.formatted || 'N√£o encontrado';
  } catch (err) {
    res.endereco = 'Erro geocodifica√ß√£o: ' + err.toString();
  }
  try {
    const directionRes = UrlFetchApp.fetch(
      'https://api.openrouteservice.org/v2/directions/driving-car', {
        method: 'post',
        contentType: 'application/json',
        payload: JSON.stringify({ coordinates:[[lonO,latO],[lonD,latD]] }),
        headers: { Authorization: routeToken }
      }
    );
    const obj = JSON.parse(directionRes.getContentText());
    const km = obj.routes[0].summary.distance / 1000;
    const tot = km * 2;
    const exc = Math.max(0, tot - 40);
    const custo = exc * 2.0;
    res.distanciaHtml =
      `üìç Ida: <b>${km.toFixed(2)} km</b><br>` +
      `üîÑ Total: <b>${tot.toFixed(2)} km</b><br>` +
      `üéØ Exc: <b>${exc.toFixed(2)} km</b><br>` +
      `üí∞ R$ ${custo.toFixed(2)}`;
  } catch (err) {
    res.error = 'Erro rota: ' + err.toString();
  }
  return JSON.stringify(res);
}

/**
 * Adiciona menu ao abrir
 */
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('üìè KM adicional')
    .addItem('Abrir calculadora', 'abrirCalculadora')
    .addToUi();
}

/**
 * Abre o modal da calculadora com tratamento de erro
 */
function abrirCalculadora() {
  const ui = SpreadsheetApp.getUi();
  try {
    const html = HtmlService.createHtmlOutputFromFile('Calculadora')
      .setWidth(480)
      .setHeight(580);
    ui.showModalDialog(html, 'Calculadora KM');
  } catch (err) {
    ui.alert('N√£o foi poss√≠vel abrir a calculadora:\n' + err.toString());
  }
}
