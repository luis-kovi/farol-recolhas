<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Recolhas - Kovi</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/ksMQSMQ2/web-app-manifest-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #FF355A;
      --primary-color-darker: #E02E4D;
      --scrollbar-track: #f1f1f1;
      --scrollbar-thumb: #c1c1c1;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fa;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .bg-primary {
      background-color: var(--primary-color);
    }
    .control-btn.active {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
      transition: background-color 0.2s;
    }
    .btn-primary:hover {
      background-color: var(--primary-color-darker);
    }
    .text-primary {
      color: var(--primary-color);
    }
    .border-primary {
      border-color: var(--primary-color);
    }
    .focus-primary:focus {
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 2px rgba(255, 53, 90, 0.4) !important;
    }
    .scroll-container {
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: transparent transparent;
      transition: scrollbar-color 0.3s ease;
    }
    .scroll-container:hover {
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
    }
    .scroll-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
      background-color: transparent;
    }
    .scroll-container::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
    }
    .scroll-container::-webkit-scrollbar-thumb {
      background-color: transparent;
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    .scroll-container:hover::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
    }
    .scroll-container:hover::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
    }
    .scroll-container::-webkit-scrollbar-thumb:hover {
      background-color: #a0a0a0;
    }
    .kanban-board {
      scrollbar-gutter: stable;
    }
    .modal-overlay {
      transition: opacity 0.2s ease-in-out;
    }
    .modal-panel {
      transition: transform 0.2s ease-in-out;
    }
    .phase-title {
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .table-header-primary th {
      color: var(--primary-color);
      font-weight: 700;
    }
    .table-border-primary {
      border-top: 4px solid var(--primary-color);
    }
    .compact-table td {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .split-modal {
      display: flex;
      height: 60vh;
    }
    .split-modal-left {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      border-right: 1px solid #e5e7eb;
    }
    .split-modal-right {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    .split-modal-right iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body class="text-gray-800">

  <div class="flex flex-col h-screen">
    <header class="bg-primary text-white flex-shrink-0">
      <div class="flex justify-between items-center px-4 py-3">
        <div class="flex items-center gap-4">
          <img src="https://i.ibb.co/zh6PNsYs/kovi-logo-fundo-rosa.png" alt="Logo Kovi" class="h-10">
          <span class="text-white opacity-50">/</span>
          <h1 class="text-lg font-semibold" style="font-family: 'Poppins', sans-serif; font-weight: 800;">Gestão de Recolhas</h1>
        </div>
        <div class="flex items-center gap-4">
          <button id="open-calculator-btn" title="Abrir Calculadora de Distância" class="hidden bg-white text-primary px-3 py-1.5 rounded-md text-sm font-semibold hover:bg-gray-100 transition flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/><path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"/></svg>
            Calculadora
          </button>
          
          <img id="user-avatar" src="https://placehold.co/40x40/FFFFFF/FF355A?text=K" alt="Foto do Perfil" class="h-10 w-10 rounded-full">
          <div>
              <p id="user-name" class="font-bold text-sm">Utilizador Kovi</p>
              <p id="user-email" class="text-xs">A carregar...</p>
          </div>
          <button id="logout-btn" class="text-white hover:text-gray-200 ml-2 flex items-center gap-1 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg>
            Sair
          </button>
        </div>
      </div>
    </header>
    
    <div class="py-3 bg-white border-b border-gray-200 flex-shrink-0">
        </div>


    <main class="flex-1 flex overflow-hidden">
        </main>
  </div>

  <div id="cardModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
      </div>

  <script>
    const SCRIPT_URL = "SUA_URL_DE_IMPLANTAÇÃO_DO_APPS_SCRIPT_AQUI"; // Certifique-se que esta URL é da ÚLTIMA implantação

    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'login.html';
    }

    // Suas funções de `buildUI`, `buildKanbanView`, etc., permanecem aqui...

    document.addEventListener('DOMContentLoaded', function() {
      // Suas constantes de elementos originais...
      const openCalculatorBtn = document.getElementById('open-calculator-btn');

      // Suas funções e event listeners originais...

      function fetchData() {
          const url = `${SCRIPT_URL}?email=${encodeURIComponent(user.email)}&t=${new Date().getTime()}`;
          fetch(url)
              .then(response => response.json())
              .then(data => {
                  if (data.error) throw new Error(data.error);
                  
                  loadingIndicator.style.display = 'none';
                  kanbanView.classList.remove('hidden');
                  kanbanView.classList.add('flex');
                  
                  const perm = data.permissionType ? data.permissionType.toLowerCase() : '';
                  if (perm === 'kovi' || perm === 'onsystem') {
                    openCalculatorBtn.classList.remove('hidden');
                  }

                  onDataRefreshed(data);
              })
              .catch(err => {
                  console.error("Falha ao carregar dados:", err);
                  loadingIndicator.innerHTML = `<p class="text-red-500">Erro ao carregar dados. Verifique console.</p>`;
              });
      }

      // --- NOVA LÓGICA DO MODAL DA CALCULADORA ---
      
      openCalculatorBtn.addEventListener('click', async () => {
        if (document.getElementById('calculator-modal-container')) return;

        // 1. Cria o contêiner do modal
        const modalContainer = document.createElement('div');
        modalContainer.id = 'calculator-modal-container';
        modalContainer.className = 'fixed top-20 left-1/2 -translate-x-1/2 z-[60]';
        
        // 2. Busca o HTML da calculadora e o injeta no contêiner
        try {
            const response = await fetch('calculadora.html');
            if (!response.ok) throw new Error('Não foi possível carregar calculadora.html');
            modalContainer.innerHTML = await response.text();
            document.body.appendChild(modalContainer);
            
            // 3. Adiciona os eventos e a lógica APÓS o modal ser inserido na página
            setupCalculatorModal(modalContainer);
        } catch(error) {
            console.error("Erro ao carregar o modal da calculadora:", error);
            alert("Não foi possível abrir a calculadora.");
        }
      });

      function setupCalculatorModal(modalContainer) {
        const header = modalContainer.querySelector('#calculator-modal-header');
        const closeBtn = modalContainer.querySelector('#close-calculator-btn');
        const calcBtn = modalContainer.querySelector('#calculate-btn');

        // Lógica para fechar
        closeBtn.addEventListener('click', () => modalContainer.remove());

        // Lógica para calcular
        calcBtn.addEventListener('click', () => {
          const origem = modalContainer.querySelector("#origem").value;
          const destino = modalContainer.querySelector("#destino").value;
          const resultDiv = modalContainer.querySelector("#result-calculator");
          const enderecoDiv = modalContainer.querySelector("#enderecoOrigem");
          const loading = modalContainer.querySelector("#loading-calculator");

          loading.style.display = 'block';
          resultDiv.style.display = 'none';
          enderecoDiv.style.display = 'none';

          const payload = { action: 'calcularDistancia', data: { origemStr: origem, destinoStr: destino }};

          fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'application/json' },
          })
          .then(res => res.json())
          .then(data => {
            loading.style.display = 'none';
            resultDiv.style.display = 'block';

            if (data.endereco) {
              enderecoDiv.innerHTML = `📍 <b>Origem:</b> ${data.endereco}`;
              enderecoDiv.style.display = 'block';
            }
            if (data.error) {
              resultDiv.innerHTML = data.error;
            } else {
              resultDiv.innerHTML = data.distanciaHtml;
            }
          })
          .catch(err => {
            loading.style.display = 'none';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = "❌ Ocorreu um erro de comunicação com o servidor.";
            console.error(err);
          });
        });

        // Lógica para arrastar
        let isDragging = false, offset = { x: 0, y: 0 };
        header.addEventListener('mousedown', (e) => {
          isDragging = true;
          offset = { x: e.clientX - modalContainer.offsetLeft, y: e.clientY - modalContainer.offsetTop };
        });
        document.addEventListener('mouseup', () => isDragging = false );
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          modalContainer.style.left = `${e.clientX - offset.x}px`;
          modalContainer.style.top = `${e.clientY - offset.y}px`;
          // Remove a transformação para que a posição seja absoluta
          modalContainer.style.transform = 'none'; 
        });
      }

      // --- FIM DA NOVA LÓGICA ---

      // Seu código restante (logout, fetchData inicial, setInterval) permanece o mesmo
      fetchData();
      setInterval(fetchData, 30000);
    });
  </script>

</body>
</html>
