<script>
    // IMPORTANTE: Verifique se esta √© a URL da sua √öLTIMA implanta√ß√£o
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxEFO0dh_zKxsq0xNOY4pJH85A4-OKxUewqhYPZldsjqbM2E5GIOjJ2wL5JdZcXD44/exec"; 

    // VERIFICA√á√ÉO DE LOGIN
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'login.html';
    }

    const fixedPhaseOrder = [
      'Fila de Recolha',
      'Tentativa 1 de Recolha',
      'Tentativa 2 de Recolha',
      'Tentativa 3 de Recolha',
      'Nova tentativa de recolha',
      'Confirma√ß√£o de Entrega no P√°tio'
    ];

    const phaseDisplayNames = {
      'Fila de Recolha': 'Fila de Recolha',
      'Tentativa 1 de Recolha': 'Tentativa 1',
      'Tentativa 2 de Recolha': 'Tentativa 2',
      'Tentativa 3 de Recolha': 'Tentativa 3',
      'Nova tentativa de recolha': 'Nova Tentativa',
      'Confirma√ß√£o de Entrega no P√°tio': 'Confirma√ß√£o de Recolha'
    };

    function buildUI(cards) {
        buildKanbanView(cards);
        buildListView(cards);
    }
    
    function buildKanbanView(cards) {
        const container = document.getElementById('kanban-container');
        if (!container) return;
        const phases = {};
        fixedPhaseOrder.forEach(phaseName => { phases[phaseName] = []; });
        cards.forEach(card => {
            if (phases[card.faseAtual]) {
                phases[card.faseAtual].push(card);
            }
        });
        let html = '';
        fixedPhaseOrder.forEach(phaseName => {
            const cardsInPhase = phases[phaseName];
            const lateOrAlertCount = cardsInPhase.filter(c => c.sla >= 2).length;
            const displayPhaseName = phaseDisplayNames[phaseName] || phaseName;
            html += `<div class="w-64 bg-gray-100 rounded-lg flex flex-col flex-shrink-0">
                    <div class="p-3 flex items-center bg-white rounded-t-lg border-t-4 border-primary">
                        <h2 class="phase-title text-primary">${displayPhaseName}</h2>
                        <span class="text-sm font-semibold text-gray-500 bg-gray-200 rounded-md px-2 py-0.5 ml-2 card-count">${cardsInPhase.length}</span>
                        ${lateOrAlertCount > 0 ? `<span class="ml-auto flex items-center text-amber-600 font-semibold text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${lateOrAlertCount}</span>` : ''}
                    </div>
                    <div class="flex-1 p-2 space-y-2 overflow-y-auto scroll-container">
                        ${cardsInPhase.length > 0 ? cardsInPhase.map(card => buildCardHTML(card)).join('') : `<div class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-4"><p class="text-sm font-medium">N√£o h√° recolha nesta fase.</p></div>`}
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }

    function buildCardHTML(card) {
        let slaColor = '', slaText = '';
        if (card.sla >= 3) { slaColor = 'bg-red-100 text-red-700'; slaText = 'Atrasado'; }
        else if (card.sla == 2) { slaColor = 'bg-yellow-100 text-yellow-700'; slaText = 'Em Alerta'; }
        else { slaColor = 'bg-green-100 text-green-700'; slaText = 'No Prazo'; }
        return `<div class="kanban-card data-item bg-white rounded-md shadow-sm border border-gray-200 flex flex-col h-56 cursor-pointer hover:border-primary transition-all" ${buildDataAttributes(card)}>
                <div class="p-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs bg-gray-200 text-gray-600 font-medium px-2 py-0.5 rounded-full truncate">${card.origemLocacao}</span>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${slaColor}">${slaText}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 card-placa truncate">${card.placa}</h3>
                </div>
                <div class="flex-grow px-3 space-y-1 text-sm">
                    <p class="text-gray-500 card-driver truncate"><span class="font-semibold text-gray-600">DRIVER:</span> ${card.nomeDriver}</p>
                    <p class="text-gray-500 truncate"><span class="font-semibold text-gray-600">MODELO:</span> ${card.modeloVeiculo}</p>
                    ${card.faseAtual !== 'Fila de Recolha' ? `<p class="text-gray-500 card-chofer truncate"><span class="font-semibold text-gray-600">CHOFER:</span> ${card.chofer}</p>` : ''}
                </div>
                <div class="p-3 flex items-center justify-between border-t border-gray-100">
                    <div class="flex items-center text-xs text-red-600 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        SLA: ${card.sla} dia(s)
                    </div>
                    ${card.urlPublica ? `<button class="open-form-btn text-xs text-gray-500 hover:text-primary flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Formul√°rio</button>` : ''}
                </div>
            </div>`;
    }

    function buildListView(cards) {
        const container = document.getElementById('list-container');
        if (!container) return;
        let html = '';
        
        const filteredCards = cards.filter(card => 
            fixedPhaseOrder.includes(card.faseAtual)
        );
        
        filteredCards.sort((a, b) => b.sla - a.sla);
        
        if (filteredCards.length > 0) {
            filteredCards.forEach(card => {
                let slaText = '', slaBg = '';
                if (card.sla >= 3) { slaBg = 'bg-red-100'; slaText = 'Atrasado'; }
                else if (card.sla == 2) { slaBg = 'bg-yellow-100'; slaText = 'Em Alerta'; }
                else { slaBg = 'bg-green-100'; slaText = 'No Prazo'; }
                const displayPhase = phaseDisplayNames[card.faseAtual] || card.faseAtual;
                html += `<tr class="table-list-item data-item border-b hover:bg-gray-50 cursor-pointer ${slaBg}" ${buildDataAttributes(card)}>
                        <td class="px-6 py-2 font-bold text-gray-900 card-placa">${card.placa}</td>
                        <td class="px-6 py-2 card-driver">${card.nomeDriver}</td>
                        <td class="px-6 py-2 card-chofer">${card.chofer}</td>
                        <td class="px-6 py-2">${displayPhase}</td>
                        <td class="px-6 py-2">${card.dataCriacao}</td>
                        <td class="px-6 py-2 text-center font-bold text-lg">${card.sla}</td>
                    </tr>`;
            });
        }
        container.innerHTML = html;
    }

    function buildDataAttributes(card) {
        let slaText = '';
        if (card.sla >= 3) { slaText = 'Atrasado'; }
        else if (card.sla == 2) { slaText = 'Em Alerta'; }
        else { slaText = 'No Prazo'; }
        return `data-placa="${card.placa}" data-driver="${card.nomeDriver}" data-chofer="${card.chofer}" data-origem="${card.origemLocacao}" data-fase="${card.faseAtual}" data-criacao="${card.dataCriacao}" data-sla-dias="${card.sla}" data-mapa-url="${card.enderecoRecolhaUrl}" data-form-url="${card.urlPublica}" data-sla-text="${slaText}" data-valor-recolha="${card.valorRecolha}" data-custo-km="${card.custoKmAdicional}" data-modelo-veiculo="${card.modeloVeiculo}" data-telefone-contato="${card.telefoneContato}" data-telefone-opcional="${card.telefoneOpcional}" data-endereco-cadastro="${card.enderecoCadastro}" data-endereco-veiculo="${card.enderecoVeiculo}"`;
    }
    
    function buildModalContent(data) {
        const isFila = data.fase === 'Fila de Recolha';
        const displayPhase = phaseDisplayNames[data.fase] || data.fase;
        let valorHTML = '';
        if (!isFila && data.valorRecolha && data.valorRecolha !== 'N/A' && data.valorRecolha !== 'null') {
            valorHTML = `<div><p class="text-sm text-gray-500">Valor da Recolha</p><p class="font-semibold">R$ ${data.valorRecolha}</p></div>`;
        }
        let custoKmHTML = '';
        if (!isFila && data.custoKm && data.custoKm !== 'N/A' && data.custoKm !== 'null') {
            custoKmHTML = `<div><p class="text-sm text-gray-500">Custo KM Adicional</p><p class="font-semibold">R$ ${data.custoKm}</p></div>`;
        }
        return `<div class="grid grid-cols-2 gap-4"><div><p class="text-sm text-gray-500">SLA</p><p class="font-semibold text-lg">${data.slaDias} dias</p></div><div><p class="text-sm text-gray-500">Fase Atual</p><p class="font-semibold">${displayPhase}</p></div></div>
            <div><p class="text-sm text-gray-500">Modelo do Ve√≠culo</p><p class="font-semibold">${data.modeloVeiculo}</p></div>
            <div><p class="text-sm text-gray-500">Driver</p><p class="font-semibold">${data.driver}</p></div>
            ${!isFila ? `<div><p class="text-sm text-gray-500">Chofer</p><p class="font-semibold">${data.chofer}</p></div>` : ''}
            <div><p class="text-sm text-gray-500">Origem da Loca√ß√£o</p><p class="font-semibold">${data.origem}</p></div>
            <div><p class="text-sm text-gray-500">Telefone de Contato</p><p class="font-semibold">${data.telefoneContato}</p></div>
            <div><p class="text-sm text-gray-500">Telefone Opcional</p><p class="font-semibold">${data.telefoneOpcional}</p></div>
            <div><p class="text-sm text-gray-500">Endere√ßo de Cadastro</p><p class="font-semibold">${data.enderecoCadastro}</p></div>
            <div><p class="text-sm text-gray-500">Endere√ßo Onde o Ve√≠culo Est√°</p><p class="font-semibold">${data.enderecoVeiculo}</p></div>
            ${valorHTML}
            ${custoKmHTML}
            <div><p class="text-sm text-gray-500">Data de Cria√ß√£o</p><p class="font-semibold">${data.criacao}</p></div>`;
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('user-name').textContent = user.displayName;
      document.getElementById('user-email').textContent = user.email;
      document.getElementById('user-avatar').src = user.photoURL;

      const searchInput = document.getElementById('searchInput');
      const slaFilter = document.getElementById('slaFilter');
      const kanbanView = document.getElementById('kanban-view');
      const listView = document.getElementById('list-view');
      const loadingIndicator = document.getElementById('loading-indicator');
      const kanbanBtn = document.getElementById('kanban-view-btn');
      const listBtn = document.getElementById('list-view-btn');
      const cardModal = document.getElementById('cardModal');
      const closeCardModalBtn = document.getElementById('closeCardModal');
      const modalFormIframe = document.getElementById('modalFormIframe');
      const mainContent = document.querySelector('main');
      const logoutBtn = document.getElementById('logout-btn');
      const openCalculatorBtn = document.getElementById('open-calculator-btn');

      mainContent.addEventListener('click', function(event) {
        const target = event.target;
        const formButton = target.closest('.open-form-btn');
        if (formButton) {
            event.stopPropagation();
            const cardElement = formButton.closest('.data-item');
            if (cardElement && cardElement.dataset.formUrl) openCardModal(cardElement);
            return;
        }
        const cardElement = target.closest('.data-item');
        if (cardElement) {
            openCardModal(cardElement);
        }
      });

      function filterAndSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        const currentSlaFilter = slaFilter.value;
        document.querySelectorAll('.data-item').forEach(item => {
          const placa = item.dataset.placa.toLowerCase();
          const driver = item.dataset.driver.toLowerCase();
          const chofer = item.dataset.chofer.toLowerCase();
          const slaText = item.dataset.slaText;
          const matchesSearch = placa.includes(searchTerm) || driver.includes(searchTerm) || chofer.includes(searchTerm);
          const matchesSla = (currentSlaFilter === 'all') || (slaText === currentSlaFilter);
          const shouldBeVisible = matchesSearch && matchesSla;
          if (item.classList.contains('kanban-card')) {
            item.style.display = shouldBeVisible ? 'flex' : 'none';
          } else if (item.classList.contains('table-list-item')) {
            item.style.display = shouldBeVisible ? 'table-row' : 'none';
          }
        });
        document.querySelectorAll('#kanban-view .w-64').forEach(column => {
          const visibleCards = Array.from(column.querySelectorAll('.kanban-card')).filter(card => card.style.display !== 'none').length;
          const countElement = column.querySelector('.card-count');
          if(countElement) { countElement.textContent = visibleCards; }
        });
      }

      searchInput.addEventListener('input', filterAndSearch);
      slaFilter.addEventListener('change', filterAndSearch);
      
      kanbanBtn.addEventListener('click', () => {
        kanbanView.classList.remove('hidden');
        kanbanView.classList.add('flex');
        listView.classList.add('hidden');
        kanbanBtn.classList.add('active');
        listBtn.classList.remove('active');
      });

      listBtn.addEventListener('click', () => {
        kanbanView.classList.add('hidden');
        kanbanView.classList.remove('flex');
        listView.classList.remove('hidden');
        listBtn.classList.add('active');
        kanbanBtn.classList.remove('active');
      });

      function openCardModal(itemElement) {
        const data = itemElement.dataset;
        document.getElementById('modalPlaca').textContent = data.placa;
        document.getElementById('modal-content').innerHTML = buildModalContent(data);
        
        if (data.formUrl && data.formUrl !== 'null') {
          modalFormIframe.src = data.formUrl;
        } else {
          modalFormIframe.src = "about:blank";
        }
        
        const mapaLink = document.getElementById('modalMapaLink');
        if (data.mapaUrl && data.mapaUrl !== 'null') {
          mapaLink.href = data.mapaUrl;
          mapaLink.style.display = 'inline-block';
        } else {
          mapaLink.style.display = 'none';
        }
        
        cardModal.classList.remove('hidden');
        setTimeout(() => cardModal.querySelector('.modal-panel').classList.remove('opacity-0', 'scale-95'), 10);
      }

      function closeCardModal() {
        const panel = cardModal.querySelector('.modal-panel');
        panel.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
          cardModal.classList.add('hidden');
          modalFormIframe.src = "about:blank";
        }, 200);
      }
      
      function onDataRefreshed(sheetData) {
        buildUI(sheetData.cards);
        console.log("Dados atualizados em: " + sheetData.lastUpdate);
        filterAndSearch();
      }
      
      function fetchData() {
          const url = `${SCRIPT_URL}?req=cards&email=${encodeURIComponent(user.email)}&t=${new Date().getTime()}`;
          fetch(url)
              .then(response => {
                  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                  return response.json();
              })
              .then(data => {
                  if (data.error) throw new Error(data.error);
                  loadingIndicator.style.display = 'none';
                  kanbanView.classList.remove('hidden');
                  kanbanView.classList.add('flex');
                  
                  const perm = data.permissionType ? data.permissionType.toLowerCase() : '';
                  if (perm === 'kovi' || perm === 'onsystem') {
                    openCalculatorBtn.classList.remove('hidden');
                  }
                  onDataRefreshed(data);
              })
              .catch(err => {
                  console.error("Falha ao carregar dados:", err);
                  loadingIndicator.innerHTML = `<p class="text-red-500">Erro ao carregar dados. Verifique console.</p>`;
              });
      }

      openCalculatorBtn.addEventListener('click', async () => {
        if (document.getElementById('calculator-modal-container')) return;
        const modalContainer = document.createElement('div');
        modalContainer.id = 'calculator-modal-container';
        modalContainer.className = 'fixed top-20 left-1/2 -translate-x-1/2 z-[60]';
        
        try {
            const response = await fetch('calculadora.html');
            if (!response.ok) throw new Error('N√£o foi poss√≠vel carregar calculadora.html');
            modalContainer.innerHTML = await response.text();
            document.body.appendChild(modalContainer);
            setupCalculatorModal(modalContainer);
        } catch(error) {
            console.error("Erro ao carregar o modal da calculadora:", error);
            alert("N√£o foi poss√≠vel abrir a calculadora.");
        }
      });

      function setupCalculatorModal(modalContainer) {
        const header = modalContainer.querySelector('#calculator-modal-header');
        const closeBtn = modalContainer.querySelector('#close-calculator-btn');
        const calcBtn = modalContainer.querySelector('#calculate-btn');
        const origemInputEl = modalContainer.querySelector('#origem');

        closeBtn.addEventListener('click', () => modalContainer.remove());

        const performCalculation = () => {
          const origemValue = origemInputEl.value;
          const destinoValue = modalContainer.querySelector("#destino").value;
          const resultDiv = modalContainer.querySelector("#result-calculator");
          const enderecoDiv = modalContainer.querySelector("#enderecoOrigem");
          const loading = modalContainer.querySelector("#loading-calculator");

          loading.style.display = 'block';
          resultDiv.style.display = 'none';
          enderecoDiv.style.display = 'none';

          const calculationUrl = new URL(SCRIPT_URL);
          calculationUrl.searchParams.append('action', 'calcularDistancia');
          calculationUrl.searchParams.append('origem', origemValue);
          calculationUrl.searchParams.append('destino', destinoValue);

          fetch(calculationUrl)
          .then(res => {
            if (!res.ok) throw new Error(`Erro na API: ${res.statusText}`);
            return res.json();
          })
          .then(data => {
            loading.style.display = 'none';
            resultDiv.style.display = 'block';

            if (data.endereco) {
              enderecoDiv.innerHTML = `üìç <b>Origem:</b> ${data.endereco}`;
              enderecoDiv.style.display = 'block';
            }
            if (data.error) {
              resultDiv.innerHTML = data.error;
            } else {
              resultDiv.innerHTML = data.distanciaHtml;
            }
          })
          .catch(err => {
            loading.style.display = 'none';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = "‚ùå Ocorreu um erro de comunica√ß√£o com o servidor.";
            console.error(err);
          });
        };

        calcBtn.addEventListener('click', performCalculation);
        origemInputEl.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performCalculation();
        });

        let isDragging = false, offset = { x: 0, y: 0 };
        header.addEventListener('mousedown', (e) => {
          isDragging = true;
          offset = { x: e.clientX - modalContainer.offsetLeft, y: e.clientY - modalContainer.offsetTop };
        });
        document.addEventListener('mouseup', () => { isDragging = false; });
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          modalContainer.style.left = `${e.clientX - offset.x}px`;
          modalContainer.style.top = `${e.clientY - offset.y}px`;
          modalContainer.style.transform = 'none';
        });
      }

      function logout() {
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }

      closeCardModalBtn.addEventListener('click', closeCardModal);
      cardModal.addEventListener('click', e => { if (e.target === cardModal) closeCardModal(); });
      logoutBtn.addEventListener('click', logout);

      fetchData();
      setInterval(fetchData, 30000);
    });
  </script>
